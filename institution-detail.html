<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»„ç»‡æ¶æ„ç®¡ç† - æ™ºèƒ½è¥é”€å¹³å°</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .sidebar {
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
        }

        .nav-item.active {
            background: rgba(82, 196, 26, 0.2);
            border-left-color: #52c41a;
        }

        .logo-icon {
            background: #52c41a;
        }

        /* é¡µé¢ä¸»å¸ƒå±€ - å·¦æ ‘å³è¡¨ */
        .org-layout {
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }

        /* å·¦ä¾§æ ‘å½¢ç»“æ„ */
        .org-tree-panel {
            width: 280px;
            flex-shrink: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .org-tree-header {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .org-tree-header h4 {
            font-size: 14px;
            font-weight: 600;
            color: #262626;
        }

        .org-tree-body {
            padding: 12px;
            max-height: calc(100vh - 180px);
            overflow-y: auto;
        }

        /* æ ‘èŠ‚ç‚¹ */
        .tree-node {
            user-select: none;
        }

        .tree-node-content {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 13px;
            color: #595959;
        }

        .tree-node-content:hover {
            background: #f5f5f5;
        }

        .tree-node-content.active {
            background: #e6f7ff;
            color: #1890ff;
            font-weight: 500;
        }

        .tree-toggle {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #bfbfbf;
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .tree-toggle.expanded {
            transform: rotate(90deg);
        }

        .tree-toggle.hidden {
            visibility: hidden;
        }

        .tree-icon {
            font-size: 14px;
            flex-shrink: 0;
        }

        .tree-label {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .tree-badge {
            font-size: 11px;
            color: #bfbfbf;
            flex-shrink: 0;
        }

        .tree-children {
            padding-left: 20px;
        }

        .tree-children.collapsed {
            display: none;
        }

        /* å³ä¾§ä¿¡æ¯é¢æ¿ */
        .org-detail-panel {
            flex: 1;
            min-width: 0;
        }

        /* èŠ‚ç‚¹ä¿¡æ¯å¡ */
        .node-info-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            padding: 20px 24px;
            margin-bottom: 16px;
        }

        .node-info-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .node-info-header h3 {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .node-level-tag {
            font-size: 12px;
            padding: 2px 10px;
            border-radius: 10px;
            font-weight: 500;
        }

        .level-hq {
            background: #f9f0ff;
            color: #722ed1;
        }

        .level-branch {
            background: #e6f7ff;
            color: #1890ff;
        }

        .level-sub {
            background: #f6ffed;
            color: #52c41a;
        }

        .level-outlet {
            background: #fff7e6;
            color: #fa8c16;
        }

        .node-info-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        .node-info-item {
            padding: 12px;
            background: #fafafa;
            border-radius: 6px;
        }

        .node-info-item .info-label {
            font-size: 12px;
            color: #8c8c8c;
            margin-bottom: 4px;
        }

        .node-info-item .info-value {
            font-size: 15px;
            font-weight: 600;
            color: #262626;
        }

        .node-info-item .info-value.highlight {
            color: #1890ff;
        }

        /* åŒºåŸŸæ ‡ç­¾ */
        .region-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 12px;
        }

        .region-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: #f0f0f0;
            border-radius: 4px;
            font-size: 12px;
            color: #595959;
        }

        .region-tag .region-icon {
            font-size: 12px;
        }

        /* è´¦å·åˆ—è¡¨ */
        .account-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .account-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            border-bottom: 1px solid #f0f0f0;
        }

        .account-header h4 {
            font-size: 14px;
            font-weight: 600;
            color: #262626;
        }

        .account-table {
            width: 100%;
            border-collapse: collapse;
        }

        .account-table th {
            text-align: left;
            padding: 10px 16px;
            background: #fafafa;
            font-weight: 500;
            color: #8c8c8c;
            font-size: 13px;
            border-bottom: 1px solid #f0f0f0;
        }

        .account-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f5f5f5;
            font-size: 13px;
            color: #262626;
        }

        .account-table tbody tr:hover {
            background: #fafafa;
        }

        .account-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .account-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 500;
            flex-shrink: 0;
        }

        .role-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .role-admin {
            background: #f9f0ff;
            color: #722ed1;
        }

        .role-head {
            background: #e6f7ff;
            color: #1890ff;
        }

        .role-manager {
            background: #f6ffed;
            color: #52c41a;
        }

        .workload-bar {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .workload-track {
            width: 60px;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .workload-fill {
            height: 100%;
            border-radius: 3px;
        }

        .workload-fill.light {
            background: #52c41a;
        }

        .workload-fill.medium {
            background: #faad14;
        }

        .workload-fill.heavy {
            background: #ff4d4f;
        }

        .status-dot {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
        }

        .status-dot::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .status-dot.online::before {
            background: #52c41a;
        }

        .status-dot.offline::before {
            background: #d9d9d9;
        }

        /* æ–°å¢è´¦å·å¼¹çª— */
        .add-account-modal .modal {
            max-width: 500px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* é¢åŒ…å±‘ */
        .org-breadcrumb {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #8c8c8c;
            margin-bottom: 4px;
        }

        .org-breadcrumb span {
            cursor: pointer;
        }

        .org-breadcrumb span:hover {
            color: #1890ff;
        }

        .org-breadcrumb .sep {
            color: #d9d9d9;
            cursor: default;
        }

        .org-breadcrumb .sep:hover {
            color: #d9d9d9;
        }

        /* ç¼–è¾‘èŠ‚ç‚¹å¼¹çª— */
        .edit-node-modal .modal {
            max-width: 480px;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: #262626;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 10000;
            transition: transform 0.3s ease;
            white-space: nowrap;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        .toast.success {
            background: linear-gradient(135deg, #52c41a, #73d13d);
        }

        /* ç©ºçŠ¶æ€ */
        .empty-accounts {
            text-align: center;
            padding: 40px 20px;
            color: #bfbfbf;
        }

        .empty-accounts .empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .empty-accounts p {
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <div class="logo-icon">âš™ï¸</div>
                <h1>è¿è¥ç®¡æ§å°</h1>
            </div>
            
            <nav class="nav-menu">
                <a href="index.html" class="nav-item "><span class="nav-icon">ğŸ“Š</span><span class="nav-text">è¿è¥æ¦‚è§ˆ</span></a>
                
                <div style="height: 1px; background: rgba(255,255,255,0.1); margin: 8px 16px;"></div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.45); padding: 8px 24px; margin-top: 4px;">æ•°æ®äº¤ä»˜</div>
                <a href="smart-search.html" class="nav-item "><span class="nav-icon">ğŸ¯</span><span class="nav-text">æ™ºèƒ½æ¢å®¢</span></a>
                <a href="batch-enrich.html" class="nav-item "><span class="nav-icon">ğŸ“‘</span><span class="nav-text">æ‰¹é‡ç”»åƒæŸ¥è¯¢</span></a>
                
                <div style="height: 1px; background: rgba(255,255,255,0.1); margin: 8px 16px;"></div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.45); padding: 8px 24px; margin-top: 4px;">ä¸šåŠ¡ç®¡ç†</div>
                <a href="institutions.html" class="nav-item "><span class="nav-icon">ğŸ›ï¸</span><span class="nav-text">æœºæ„ç®¡ç†</span></a>
                <a href="customer-pool.html" class="nav-item "><span class="nav-icon">ğŸŠ</span><span class="nav-text">å®¢æˆ·æ± </span></a>
                <a href="products.html" class="nav-item "><span class="nav-icon">ğŸ“¦</span><span class="nav-text">äº§å“é…ç½®</span></a>
                <a href="rules.html" class="nav-item "><span class="nav-icon">ğŸ¯</span><span class="nav-text">è§„åˆ™å¼•æ“</span></a>
                <a href="distribution.html" class="nav-item "><span class="nav-icon">ğŸ”€</span><span class="nav-text">åˆ†å‘ç®¡ç†</span></a>
                <a href="analytics.html" class="nav-item "><span class="nav-icon">ğŸ“ˆ</span><span class="nav-text">æ•ˆæœåˆ†æ</span></a>
                <a href="billing.html" class="nav-item "><span class="nav-icon">ğŸ’°</span><span class="nav-text">æ”¶è´¹ç»“ç®—</span></a>
                <a href="reconciliation.html" class="nav-item "><span class="nav-icon">ğŸ“‘</span><span class="nav-text">å¯¹è´¦ç®¡ç†</span></a>
                <a href="risk-alert.html" class="nav-item "><span class="nav-icon">âš ï¸</span><span class="nav-text">é£é™©é¢„è­¦</span></a>
                
                <div style="height: 1px; background: rgba(255,255,255,0.1); margin: 8px 16px;"></div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.45); padding: 8px 24px; margin-top: 4px;">ç³»ç»Ÿé…ç½®</div>
                <a href="api-monitor.html" class="nav-item "><span class="nav-icon">ğŸ”Œ</span><span class="nav-text">APIç›‘æ§</span></a>
                <a href="downloads.html" class="nav-item "><span class="nav-icon">ğŸ“¥</span><span class="nav-text">ä¸‹è½½ä¸­å¿ƒ</span></a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" style="background: #52c41a;">ç®¡</div>
                    <div>
                        <div class="user-name">ç®¡ç†å‘˜</div>
                        <div class="user-role">å¹³å°è¿è¥</div>
                    </div>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 class="page-title" id="pageTitle">ç»„ç»‡æ¶æ„ç®¡ç†</h1>
                    <p class="page-breadcrumb"><a href="index.html">è¿è¥æ¦‚è§ˆ</a> / <a href="institutions.html">æœºæ„ç®¡ç†</a> /
                        <span id="instName">æ±Ÿè‹é“¶è¡Œ</span>
                    </p>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-default" onclick="openModal('addNodeModal')">+ æ·»åŠ ä¸‹çº§</button>
                    <button class="btn btn-primary" onclick="openModal('addAccountModal')">+ æ–°å¢è´¦å·</button>
                </div>
            </div>

            <div class="org-layout">
                <!-- å·¦ä¾§ï¼šç»„ç»‡æ ‘ -->
                <div class="org-tree-panel">
                    <div class="org-tree-header">
                        <h4>ğŸ›ï¸ ç»„ç»‡æ¶æ„</h4>
                        <button class="btn btn-text btn-sm" onclick="expandAll()">å…¨éƒ¨å±•å¼€</button>
                    </div>
                    <div class="org-tree-body" id="orgTree">
                        <!-- åŠ¨æ€æ¸²æŸ“ -->
                    </div>
                </div>

                <!-- å³ä¾§ï¼šä¿¡æ¯é¢æ¿ -->
                <div class="org-detail-panel">
                    <!-- èŠ‚ç‚¹ä¿¡æ¯å¡ -->
                    <div class="node-info-card" id="nodeInfoCard">
                        <!-- åŠ¨æ€æ¸²æŸ“ -->
                    </div>

                    <!-- è´¦å·åˆ—è¡¨ -->
                    <div class="account-card">
                        <div class="account-header">
                            <h4>ğŸ‘¥ è´¦å·åˆ—è¡¨ <span id="accountCount"
                                    style="font-weight: 400; color: #8c8c8c; font-size: 13px;">ï¼ˆ0äººï¼‰</span></h4>
                            <div style="display: flex; gap: 8px;">
                                <select class="form-select" style="width: 120px; padding: 4px 8px; font-size: 13px;"
                                    onchange="filterAccounts(this.value)">
                                    <option value="">å…¨éƒ¨è§’è‰²</option>
                                    <option value="ç®¡ç†å‘˜">ç®¡ç†å‘˜</option>
                                    <option value="è¡Œé•¿">è¡Œé•¿</option>
                                    <option value="å®¢æˆ·ç»ç†">å®¢æˆ·ç»ç†</option>
                                </select>
                            </div>
                        </div>
                        <div id="accountTableContainer">
                            <!-- åŠ¨æ€æ¸²æŸ“ -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- æ–°å¢è´¦å·å¼¹çª— -->
    <div class="modal-overlay add-account-modal" id="addAccountModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">æ–°å¢è´¦å·</h3>
                <div class="modal-close" onclick="closeModal('addAccountModal')">âœ•</div>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">å§“å *</label>
                        <input type="text" class="form-input" placeholder="è¯·è¾“å…¥å§“å">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ‰‹æœºå· *</label>
                        <input type="text" class="form-input" placeholder="è¯·è¾“å…¥æ‰‹æœºå·">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">è§’è‰² *</label>
                        <select class="form-select" id="newAccountRole">
                            <option value="å®¢æˆ·ç»ç†">å®¢æˆ·ç»ç†</option>
                            <option value="è¡Œé•¿">æ”¯è¡Œè¡Œé•¿</option>
                            <option value="ç®¡ç†å‘˜">ç®¡ç†å‘˜</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ‰€å±ç»„ç»‡ *</label>
                        <input type="text" class="form-input" id="newAccountOrg" readonly>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">ç®¡è¾–åŒºåŸŸ</label>
                    <input type="text" class="form-input" placeholder="å¦‚ï¼šè‹å·å·¥ä¸šå›­åŒºã€è‹å·é«˜æ–°åŒº">
                </div>
                <div class="form-group">
                    <label class="form-label">å¤‡æ³¨</label>
                    <input type="text" class="form-input" placeholder="å¯é€‰">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default" onclick="closeModal('addAccountModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addAccount()">ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ ä¸‹çº§ç»„ç»‡å¼¹çª— -->
    <div class="modal-overlay edit-node-modal" id="addNodeModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">æ·»åŠ ä¸‹çº§ç»„ç»‡</h3>
                <div class="modal-close" onclick="closeModal('addNodeModal')">âœ•</div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ä¸Šçº§ç»„ç»‡</label>
                    <input type="text" class="form-input" id="parentNodeName" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">ç»„ç»‡åç§° *</label>
                    <input type="text" class="form-input" placeholder="å¦‚ï¼šå—äº¬åˆ†è¡Œã€æ–°åŒºæ”¯è¡Œ">
                </div>
                <div class="form-group">
                    <label class="form-label">ç®¡è¾–åŒºåŸŸ</label>
                    <input type="text" class="form-input" placeholder="å¦‚ï¼šè‹å·å¸‚å…¨åŸŸ">
                </div>
                <div class="form-group">
                    <label class="form-label">åœ°å€</label>
                    <input type="text" class="form-input" placeholder="å¦‚ï¼šè‹å·å·¥ä¸šå›­åŒºè‹å·å¤§é“è¥¿205å·">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default" onclick="closeModal('addNodeModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addNode()">ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘èŠ‚ç‚¹å¼¹çª— -->
    <div class="modal-overlay edit-node-modal" id="editNodeModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">ç¼–è¾‘ç»„ç»‡ä¿¡æ¯</h3>
                <div class="modal-close" onclick="closeModal('editNodeModal')">âœ•</div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ç»„ç»‡åç§°</label>
                    <input type="text" class="form-input" id="editNodeName">
                </div>
                <div class="form-group">
                    <label class="form-label">ç®¡è¾–åŒºåŸŸ</label>
                    <input type="text" class="form-input" id="editNodeRegion" placeholder="å¤šä¸ªåŒºåŸŸç”¨é¡¿å·åˆ†éš”">
                </div>
                <div class="form-group">
                    <label class="form-label">åœ°å€</label>
                    <input type="text" class="form-input" id="editNodeAddress">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default" onclick="closeModal('editNodeModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveNode()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ========== Mock ç»„ç»‡æ¶æ„æ•°æ® ==========
        const orgData = {
            id: 'hq',
            name: 'æ±Ÿè‹é“¶è¡Œæ€»è¡Œ',
            level: 'æ€»è¡Œ',
            region: ['æ±Ÿè‹çœ'],
            address: 'å—äº¬å¸‚å»ºé‚ºåŒºæ±Ÿä¸œä¸­è·¯228å·',
            children: [
                {
                    id: 'sz',
                    name: 'è‹å·åˆ†è¡Œ',
                    level: 'åˆ†è¡Œ',
                    region: ['è‹å·å¸‚'],
                    address: 'è‹å·å¸‚å§‘è‹åŒºäººæ°‘è·¯1023å·',
                    children: [
                        {
                            id: 'sz-tech',
                            name: 'ç§‘æŠ€æ”¯è¡Œ',
                            level: 'æ”¯è¡Œ',
                            region: ['è‹å·å·¥ä¸šå›­åŒº', 'è‹å·é«˜æ–°åŒº'],
                            address: 'è‹å·å·¥ä¸šå›­åŒºè‹å·å¤§é“è¥¿205å·',
                            children: [
                                {
                                    id: 'sz-tech-park',
                                    name: 'å›­åŒºç½‘ç‚¹',
                                    level: 'ç½‘ç‚¹',
                                    region: ['è‹å·å·¥ä¸šå›­åŒº'],
                                    address: 'è‹å·å·¥ä¸šå›­åŒºæ˜Ÿæ¹–è¡—328å·',
                                    children: []
                                },
                                {
                                    id: 'sz-tech-snd',
                                    name: 'é«˜æ–°åŒºç½‘ç‚¹',
                                    level: 'ç½‘ç‚¹',
                                    region: ['è‹å·é«˜æ–°åŒº'],
                                    address: 'è‹å·é«˜æ–°åŒºç‹®å±±è·¯22å·',
                                    children: []
                                }
                            ]
                        },
                        {
                            id: 'sz-city',
                            name: 'åŸä¸­æ”¯è¡Œ',
                            level: 'æ”¯è¡Œ',
                            region: ['å§‘è‹åŒº', 'ç›¸åŸåŒº'],
                            address: 'è‹å·å¸‚å§‘è‹åŒºè§‚å‰è¡—130å·',
                            children: [
                                {
                                    id: 'sz-city-gusu',
                                    name: 'è§‚å‰ç½‘ç‚¹',
                                    level: 'ç½‘ç‚¹',
                                    region: ['å§‘è‹åŒº'],
                                    address: 'è‹å·å¸‚å§‘è‹åŒºè§‚å‰è¡—130å·',
                                    children: []
                                }
                            ]
                        }
                    ]
                },
                {
                    id: 'nj',
                    name: 'å—äº¬åˆ†è¡Œ',
                    level: 'åˆ†è¡Œ',
                    region: ['å—äº¬å¸‚'],
                    address: 'å—äº¬å¸‚é¼“æ¥¼åŒºä¸­å±±è·¯18å·',
                    children: [
                        {
                            id: 'nj-jn',
                            name: 'æ±Ÿå®æ”¯è¡Œ',
                            level: 'æ”¯è¡Œ',
                            region: ['æ±Ÿå®åŒº', 'é›¨èŠ±å°åŒº'],
                            address: 'å—äº¬å¸‚æ±Ÿå®åŒºä¸œå±±è¡—é“ç«¹å±±è·¯88å·',
                            children: [
                                {
                                    id: 'nj-jn-main',
                                    name: 'æ±Ÿå®ç½‘ç‚¹',
                                    level: 'ç½‘ç‚¹',
                                    region: ['æ±Ÿå®åŒº'],
                                    address: 'å—äº¬å¸‚æ±Ÿå®åŒºä¸œå±±è¡—é“ç«¹å±±è·¯88å·',
                                    children: []
                                }
                            ]
                        }
                    ]
                }
            ]
        };

        // Mock è´¦å·æ•°æ®
        const accountsData = [
            { id: 1, name: 'æè¡Œé•¿', role: 'ç®¡ç†å‘˜', orgId: 'hq', phone: '138****1001', region: 'æ±Ÿè‹çœ', customers: 0, monthDone: 0, status: 'online', lastLogin: '2025-02-10 09:30' },
            { id: 2, name: 'å¼ æ€»', role: 'ç®¡ç†å‘˜', orgId: 'sz', phone: '138****2001', region: 'è‹å·å¸‚', customers: 0, monthDone: 0, status: 'online', lastLogin: '2025-02-10 08:45' },
            { id: 3, name: 'æè¡Œé•¿', role: 'è¡Œé•¿', orgId: 'sz-tech', phone: '138****3001', region: 'è‹å·å·¥ä¸šå›­åŒºã€è‹å·é«˜æ–°åŒº', customers: 0, monthDone: 21, status: 'online', lastLogin: '2025-02-10 10:15' },
            { id: 4, name: 'æœ±æŸäºº', role: 'å®¢æˆ·ç»ç†', orgId: 'sz-tech-park', phone: '138****4001', region: 'è‹å·å·¥ä¸šå›­åŒº', customers: 86, monthDone: 12, capacity: 100, status: 'online', lastLogin: '2025-02-10 09:00' },
            { id: 5, name: 'ææ˜', role: 'å®¢æˆ·ç»ç†', orgId: 'sz-tech-park', phone: '138****4002', region: 'è‹å·å·¥ä¸šå›­åŒº', customers: 70, monthDone: 7, capacity: 100, status: 'offline', lastLogin: '2025-02-09 17:30' },
            { id: 6, name: 'ç‹èŠ³', role: 'å®¢æˆ·ç»ç†', orgId: 'sz-tech-snd', phone: '138****5001', region: 'è‹å·é«˜æ–°åŒº', customers: 48, monthDone: 9, capacity: 100, status: 'online', lastLogin: '2025-02-10 08:30' },
            { id: 7, name: 'å¼ ä¼Ÿ', role: 'å®¢æˆ·ç»ç†', orgId: 'sz-tech-snd', phone: '138****5002', region: 'è‹å·é«˜æ–°åŒº', customers: 50, monthDone: 6, capacity: 100, status: 'online', lastLogin: '2025-02-10 09:15' },
            { id: 8, name: 'é™ˆä¸»ä»»', role: 'è¡Œé•¿', orgId: 'sz-city', phone: '138****6001', region: 'å§‘è‹åŒºã€ç›¸åŸåŒº', customers: 0, monthDone: 18, status: 'online', lastLogin: '2025-02-10 08:00' },
            { id: 9, name: 'åˆ˜æ´‹', role: 'å®¢æˆ·ç»ç†', orgId: 'sz-city-gusu', phone: '138****6002', region: 'å§‘è‹åŒº', customers: 65, monthDone: 8, capacity: 100, status: 'offline', lastLogin: '2025-02-08 16:45' },
            { id: 10, name: 'èµµè¾‰', role: 'è¡Œé•¿', orgId: 'nj-jn', phone: '138****7001', region: 'æ±Ÿå®åŒºã€é›¨èŠ±å°åŒº', customers: 0, monthDone: 15, status: 'online', lastLogin: '2025-02-10 10:00' },
            { id: 11, name: 'å­™å€©', role: 'å®¢æˆ·ç»ç†', orgId: 'nj-jn-main', phone: '138****7002', region: 'æ±Ÿå®åŒº', customers: 55, monthDone: 5, capacity: 100, status: 'online', lastLogin: '2025-02-10 09:45' },
        ];

        let currentNodeId = 'hq';
        let currentRoleFilter = '';
        let expandedNodes = new Set(['hq', 'sz', 'sz-tech', 'nj', 'nj-jn']);

        // æŸ¥æ‰¾èŠ‚ç‚¹
        function findNode(node, id) {
            if (node.id === id) return node;
            for (const child of node.children || []) {
                const found = findNode(child, id);
                if (found) return found;
            }
            return null;
        }

        // è·å–èŠ‚ç‚¹è·¯å¾„ï¼ˆé¢åŒ…å±‘ï¼‰
        function getNodePath(node, targetId, path = []) {
            path.push(node);
            if (node.id === targetId) return [...path];
            for (const child of node.children || []) {
                const result = getNodePath(child, targetId, path);
                if (result) return result;
            }
            path.pop();
            return null;
        }

        // è·å–èŠ‚ç‚¹åŠæ‰€æœ‰å­èŠ‚ç‚¹ID
        function getAllChildIds(node) {
            let ids = [node.id];
            for (const child of node.children || []) {
                ids = ids.concat(getAllChildIds(child));
            }
            return ids;
        }

        // ç»Ÿè®¡å­èŠ‚ç‚¹æ•°é‡
        function countDescendants(node) {
            let count = 0;
            for (const child of node.children || []) {
                count += 1 + countDescendants(child);
            }
            return count;
        }

        // ========== æ¸²æŸ“æ ‘ ==========
        function renderTree() {
            document.getElementById('orgTree').innerHTML = renderTreeNode(orgData, 0);
        }

        function renderTreeNode(node, depth) {
            const hasChildren = node.children && node.children.length > 0;
            const isExpanded = expandedNodes.has(node.id);
            const isActive = node.id === currentNodeId;
            const levelIcons = { 'æ€»è¡Œ': 'ğŸ›ï¸', 'åˆ†è¡Œ': 'ğŸ¢', 'æ”¯è¡Œ': 'ğŸ¬', 'ç½‘ç‚¹': 'ğŸ“' };

            // ç»Ÿè®¡æœ¬èŠ‚ç‚¹ä¸‹çš„è´¦å·æ•°
            const nodeIds = getAllChildIds(node);
            const accountCount = accountsData.filter(a => nodeIds.includes(a.orgId)).length;

            let html = `
                <div class="tree-node">
                    <div class="tree-node-content ${isActive ? 'active' : ''}" onclick="selectNode('${node.id}')">
                        <span class="tree-toggle ${hasChildren ? (isExpanded ? 'expanded' : '') : 'hidden'}"
                              onclick="event.stopPropagation(); toggleNode('${node.id}')">â–¶</span>
                        <span class="tree-icon">${levelIcons[node.level] || 'ğŸ“'}</span>
                        <span class="tree-label">${node.name}</span>
                        <span class="tree-badge">${accountCount}</span>
                    </div>
            `;

            if (hasChildren) {
                html += `<div class="tree-children ${isExpanded ? '' : 'collapsed'}">`;
                for (const child of node.children) {
                    html += renderTreeNode(child, depth + 1);
                }
                html += '</div>';
            }

            html += '</div>';
            return html;
        }

        // åˆ‡æ¢å±•å¼€
        function toggleNode(id) {
            if (expandedNodes.has(id)) {
                expandedNodes.delete(id);
            } else {
                expandedNodes.add(id);
            }
            renderTree();
        }

        // å…¨éƒ¨å±•å¼€
        function expandAll() {
            function addAll(node) {
                expandedNodes.add(node.id);
                (node.children || []).forEach(addAll);
            }
            addAll(orgData);
            renderTree();
        }

        // é€‰æ‹©èŠ‚ç‚¹
        function selectNode(id) {
            currentNodeId = id;
            currentRoleFilter = '';
            renderTree();
            renderNodeInfo();
            renderAccounts();
            // æ›´æ–°å¼¹çª—ç›¸å…³
            const node = findNode(orgData, id);
            if (node) {
                document.getElementById('newAccountOrg').value = node.name;
                document.getElementById('parentNodeName').value = node.name;
            }
        }

        // ========== æ¸²æŸ“èŠ‚ç‚¹ä¿¡æ¯ ==========
        function renderNodeInfo() {
            const node = findNode(orgData, currentNodeId);
            if (!node) return;

            const levelClass = { 'æ€»è¡Œ': 'level-hq', 'åˆ†è¡Œ': 'level-branch', 'æ”¯è¡Œ': 'level-sub', 'ç½‘ç‚¹': 'level-outlet' }[node.level] || '';
            const path = getNodePath(orgData, currentNodeId);
            const nodeIds = getAllChildIds(node);
            const accounts = accountsData.filter(a => nodeIds.includes(a.orgId));
            const onlineCount = accounts.filter(a => a.status === 'online').length;
            const totalCustomers = accounts.reduce((s, a) => s + (a.customers || 0), 0);
            const subOrgCount = countDescendants(node);

            // é¢åŒ…å±‘
            const breadcrumbHtml = path ? path.map((p, i) =>
                i < path.length - 1
                    ? `<span onclick="selectNode('${p.id}')">${p.name}</span><span class="sep">/</span>`
                    : `<span style="color: #262626; cursor: default;">${p.name}</span>`
            ).join('') : '';

            document.getElementById('nodeInfoCard').innerHTML = `
                <div class="org-breadcrumb">${breadcrumbHtml}</div>
                <div class="node-info-header">
                    <h3>
                        ${node.name}
                        <span class="node-level-tag ${levelClass}">${node.level}</span>
                    </h3>
                    <button class="btn btn-text btn-sm" onclick="openEditNode()">âœï¸ ç¼–è¾‘ä¿¡æ¯</button>
                </div>
                <div class="node-info-grid">
                    <div class="node-info-item">
                        <div class="info-label">ä¸‹çº§ç»„ç»‡</div>
                        <div class="info-value">${subOrgCount} <span style="font-size: 12px; font-weight: 400; color: #8c8c8c;">ä¸ª</span></div>
                    </div>
                    <div class="node-info-item">
                        <div class="info-label">è´¦å·æ•°é‡</div>
                        <div class="info-value highlight">${accounts.length} <span style="font-size: 12px; font-weight: 400; color: #8c8c8c;">äººï¼ˆåœ¨çº¿ ${onlineCount}ï¼‰</span></div>
                    </div>
                    <div class="node-info-item">
                        <div class="info-label">ç®¡è¾–ä¼ä¸š</div>
                        <div class="info-value">${totalCustomers > 0 ? totalCustomers.toLocaleString() : '-'} <span style="font-size: 12px; font-weight: 400; color: #8c8c8c;">å®¶</span></div>
                    </div>
                    <div class="node-info-item">
                        <div class="info-label">åœ°å€</div>
                        <div class="info-value" style="font-size: 13px; font-weight: 400;">${node.address || '-'}</div>
                    </div>
                </div>
                <div class="region-tags">
                    <span style="font-size: 12px; color: #8c8c8c; margin-right: 4px;">ç®¡è¾–åŒºåŸŸï¼š</span>
                    ${(node.region || []).map(r => `
                        <span class="region-tag"><span class="region-icon">ğŸ“</span> ${r}</span>
                    `).join('')}
                </div>
            `;
        }

        // ========== æ¸²æŸ“è´¦å·åˆ—è¡¨ ==========
        function renderAccounts() {
            const node = findNode(orgData, currentNodeId);
            if (!node) return;

            const nodeIds = getAllChildIds(node);
            let accounts = accountsData.filter(a => nodeIds.includes(a.orgId));
            if (currentRoleFilter) {
                accounts = accounts.filter(a => a.role === currentRoleFilter);
            }

            document.getElementById('accountCount').textContent = `ï¼ˆ${accounts.length}äººï¼‰`;

            if (accounts.length === 0) {
                document.getElementById('accountTableContainer').innerHTML = `
                    <div class="empty-accounts">
                        <div class="empty-icon">ğŸ‘¤</div>
                        <p>å½“å‰ç»„ç»‡ä¸‹æš‚æ— è´¦å·</p>
                        <button class="btn btn-primary btn-sm" style="margin-top: 12px;" onclick="openModal('addAccountModal')">+ æ–°å¢è´¦å·</button>
                    </div>
                `;
                return;
            }

            const avatarColors = ['#1890ff', '#52c41a', '#722ed1', '#fa8c16', '#eb2f96', '#13c2c2'];
            const roleClasses = { 'ç®¡ç†å‘˜': 'role-admin', 'è¡Œé•¿': 'role-head', 'å®¢æˆ·ç»ç†': 'role-manager' };

            document.getElementById('accountTableContainer').innerHTML = `
                <table class="account-table">
                    <thead>
                        <tr>
                            <th>å§“å</th>
                            <th>è§’è‰²</th>
                            <th>æ‰€å±ç»„ç»‡</th>
                            <th>ç®¡è¾–åŒºåŸŸ</th>
                            <th>å®¢æˆ·æ•°</th>
                            <th>è´Ÿè½½</th>
                            <th>æœ¬æœˆä¸šç»©</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${accounts.map((a, i) => {
                const org = findNode(orgData, a.orgId);
                const orgName = org ? org.name : '-';
                const loadPct = a.capacity ? Math.round(a.customers / a.capacity * 100) : 0;
                const loadClass = loadPct < 60 ? 'light' : loadPct < 85 ? 'medium' : 'heavy';
                return `
                            <tr>
                                <td>
                                    <div class="account-name">
                                        <div class="account-avatar" style="background: ${avatarColors[i % avatarColors.length]};">${a.name.charAt(0)}</div>
                                        <div>
                                            <div style="font-weight: 500;">${a.name}</div>
                                            <div style="font-size: 12px; color: #8c8c8c;">${a.phone}</div>
                                        </div>
                                    </div>
                                </td>
                                <td><span class="role-tag ${roleClasses[a.role] || ''}">${a.role}</span></td>
                                <td style="font-size: 12px; color: #595959;">${orgName}</td>
                                <td style="font-size: 12px;">${a.region}</td>
                                <td>${a.customers > 0 ? a.customers + 'å®¶' : '-'}</td>
                                <td>
                                    ${a.capacity ? `
                                    <div class="workload-bar">
                                        <div class="workload-track">
                                            <div class="workload-fill ${loadClass}" style="width: ${loadPct}%;"></div>
                                        </div>
                                        <span style="font-size: 12px; color: #8c8c8c;">${loadPct}%</span>
                                    </div>` : '-'}
                                </td>
                                <td>${a.monthDone > 0 ? a.monthDone + 'ç¬”' : '-'}</td>
                                <td>
                                    <span class="status-dot ${a.status}">${a.status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿'}</span>
                                </td>
                                <td>
                                    <button class="btn btn-text btn-sm">ç¼–è¾‘</button>
                                    <button class="btn btn-text btn-sm" style="color: #ff4d4f;">ç¦ç”¨</button>
                                </td>
                            </tr>`;
            }).join('')}
                    </tbody>
                </table>
            `;
        }

        // ç­›é€‰è´¦å·
        function filterAccounts(role) {
            currentRoleFilter = role;
            renderAccounts();
        }

        // æ‰“å¼€ç¼–è¾‘èŠ‚ç‚¹å¼¹çª—
        function openEditNode() {
            const node = findNode(orgData, currentNodeId);
            if (!node) return;
            document.getElementById('editNodeName').value = node.name;
            document.getElementById('editNodeRegion').value = (node.region || []).join('ã€');
            document.getElementById('editNodeAddress').value = node.address || '';
            openModal('editNodeModal');
        }

        // ä¿å­˜èŠ‚ç‚¹
        function saveNode() {
            closeModal('editNodeModal');
            showToast('âœ… ç»„ç»‡ä¿¡æ¯å·²æ›´æ–°');
            renderTree();
            renderNodeInfo();
        }

        // æ·»åŠ ä¸‹çº§ç»„ç»‡
        function addNode() {
            closeModal('addNodeModal');
            showToast('âœ… ä¸‹çº§ç»„ç»‡å·²æ·»åŠ ');
        }

        // æ–°å¢è´¦å·
        function addAccount() {
            closeModal('addAccountModal');
            showToast('âœ… è´¦å·å·²åˆ›å»º');
        }

        // é€šç”¨å¼¹çª—
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // Toast
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show success';
            setTimeout(() => { toast.className = 'toast'; }, 2500);
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            // å¯é€šè¿‡URLå‚æ•°æŒ‡å®šæœºæ„
            const params = new URLSearchParams(window.location.search);
            const instName = params.get('name') || 'æ±Ÿè‹é“¶è¡Œ';
            document.getElementById('instName').textContent = instName;
            document.getElementById('pageTitle').textContent = instName + ' - ç»„ç»‡æ¶æ„ç®¡ç†';

            renderTree();
            selectNode('hq');
        });
    </script>
</body>

</html>